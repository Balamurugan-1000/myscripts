#!/bin/bash

# ~/.scripts/gitpull

set -e

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ”„ You are currently on branch: $current_branch"

# Ask where to pull from (default: main)
read -rp "ğŸ“¥ Pull from which branch? (default: main): " pull_branch
pull_branch="${pull_branch:-main}" # Use input or fallback to 'main'

# Check for uncommitted changes
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "ğŸ“¦ Uncommitted changes detected. Stashing them..."
  git add .
  git stash push -m "Auto-stash before pull"
  stash_applied=true
else
  stash_applied=false
fi

# Pull from selected branch
echo "â¬‡ï¸ Pulling latest changes from origin/$pull_branch..."
if ! git pull origin "$pull_branch"; then
  echo "âŒ Git pull failed!"
  exit 1
fi

# Reapply stash if needed
if [ "$stash_applied" = true ]; then
  echo "ğŸ” Reapplying stashed changes..."
  if ! git stash pop; then
    echo -e "âš ï¸ Merge conflict occurred while applying your stash.\n"
    echo "ğŸ” Conflicted files:"
    git diff --name-only --diff-filter=U
    echo -e "\nğŸ’¡ Resolve the conflicts manually, then run:"
    echo "   git add <file> && git commit"
    exit 1
  fi
fi

echo "âœ… Code is up to date, and your changes are reapplied!"
